この実装の解説は以下の記事でしてあります。
https://qiita.com/masalennon/items/7133067dda35dedc47ed
